<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    <style>
        .session-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .session-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }

        .session-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .session-option {
            padding: 12px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .session-option:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .session-option.selected {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .session-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .session-info {
            flex: 1;
        }

        .session-id-display {
            font-family: monospace;
            font-size: 0.9em;
            color: #666;
        }

        .session-meta {
            font-size: 0.85em;
            color: #999;
            margin-top: 4px;
        }

        .loading-sessions {
            text-align: center;
            padding: 20px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="login-container">
            <h1>Login</h1>
            
            <!-- Session Selection -->
            <div class="session-selector">
                <label>Select Session:</label>
                <div id="session-list" class="session-list loading-sessions">
                    Loading...
                </div>
            </div>
            
            <form id="login-form">
                <label for="client-id">Client ID:</label>
                <input type="text" id="client-id" name="client-id" required>
                
                <div id="use-password-container" style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="use-password" style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;">
                        <span>Set password (Optional - uncheck to login without password)</span>
                    </label>
                </div>
                
                <div id="user-password-field" style="display: none;">
                    <label for="user-password">User Password:</label>
                    <input type="password" id="user-password" name="user-password" placeholder="Enter password">
                    <small id="user-password-hint" style="display: block; margin-top: -12px; margin-bottom: 12px;"></small>
                </div>
                
                <div id="session-password-field" style="display: none;">
                    <label for="session-password">Session Password:</label>
                    <input type="password" id="session-password" name="session-password" placeholder="Enter session password">
                </div>
                
                <button type="submit">Enter Chat Room</button>
            </form>
        </div>
    </div>
    <script>
        let selectedSessionId = null;
        let sessions = [];

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂá¶ÁêÜ
        window.addEventListener('DOMContentLoaded', async function() {
            // „Çª„ÉÉ„Ç∑„Éß„É≥‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„ÇÄ
            await loadSessions();
            
            // ‰øùÂ≠ò„Åï„Çå„Åü„ÇØ„É©„Ç§„Ç¢„É≥„ÉàID„Å®„Çª„ÉÉ„Ç∑„Éß„É≥„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const savedClientId = localStorage.getItem('client_id');
            const savedSessionId = localStorage.getItem('session_id');
            
            if (savedClientId && savedSessionId) {
                // ‰øùÂ≠ò„Åï„Çå„Åü„Çª„ÉÉ„Ç∑„Éß„É≥„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÅãÁ¢∫Ë™ç
                const session = sessions.find(s => s.session_id === savedSessionId && s.status === 'active');
                
                if (session) {
                    // „Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç
                    let url = `/chat?client_id=${savedClientId}&session_id=${savedSessionId}`;
                    let canAutoLogin = true;
                    
                    // „Çª„ÉÉ„Ç∑„Éß„É≥„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç
                    if (session.password_protected) {
                        const savedSessionPassword = localStorage.getItem('session_password_' + savedSessionId);
                        if (savedSessionPassword) {
                            url += `&session_password=${encodeURIComponent(savedSessionPassword)}`;
                        } else {
                            canAutoLogin = false;
                        }
                    }
                    
                    // „É¶„Éº„Ç∂„Éº„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç
                    const savedUserPassword = localStorage.getItem('user_password_' + savedSessionId + '_' + savedClientId);
                    if (savedUserPassword) {
                        url += `&user_password=${encodeURIComponent(savedUserPassword)}`;
                    }
                    
                    if (canAutoLogin) {
                        window.location.href = url;
                        return;
                    } else {
                        // „Éë„Çπ„ÉØ„Éº„Éâ„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÇíË°®Á§∫
                        localStorage.removeItem('client_id');
                        localStorage.removeItem('session_id');
                    }
                } else {
                    // „Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÁµÇ‰∫Ü„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØlocalStorage„Çí„ÇØ„É™„Ç¢
                    localStorage.removeItem('client_id');
                    localStorage.removeItem('session_id');
                }
            }
        });

        // „Çª„ÉÉ„Ç∑„Éß„É≥‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„ÇÄ
        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                const data = await response.json();
                sessions = data.sessions;
                
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆ„Åø„Éï„Ç£„É´„Çø
                const activeSessions = sessions.filter(s => s.status === 'active');
                
                displaySessions(activeSessions);
                
                // ÂàùÊúüÈÅ∏Êäû„Åï„Çå„Åü„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆË®≠ÂÆö„ÇíÈÅ©Áî®
                if (activeSessions.length > 0) {
                    updateFormForSession(activeSessions[0]);
                }
            } catch (error) {
                console.error('Failed to load sessions:', error);
                document.getElementById('session-list').innerHTML = 
                    '<div style="color: #e74c3c;">Failed to load sessions</div>';
            }
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥‰∏ÄË¶ß„ÇíË°®Á§∫
        function displaySessions(activeSessions) {
            const container = document.getElementById('session-list');
            
            if (activeSessions.length === 0) {
                container.innerHTML = '<div style="color: #999;">No active sessions</div>';
                return;
            }
            
            container.innerHTML = '';
            
            activeSessions.forEach((session, index) => {
                const option = document.createElement('div');
                option.className = 'session-option';
                if (index === 0) {
                    option.classList.add('selected');
                    selectedSessionId = session.session_id;
                }
                
                const createdDate = new Date(session.created_at).toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const lockIcon = session.password_protected ? 'üîí ' : '';
                
                option.innerHTML = `
                    <input type="radio" name="session" value="${session.session_id}" ${index === 0 ? 'checked' : ''} data-password-protected="${session.password_protected}">
                    <div class="session-info">
                        <div class="session-id-display">${lockIcon}${session.session_id}</div>
                        <div class="session-meta">
                            Created: ${createdDate} | 
                            Users: ${session.participants.length} | 
                            Messages: ${session.total_messages}
                            ${session.password_protected ? ' | üîí Protected' : ''}
                        </div>
                    </div>
                `;
                
                option.addEventListener('click', function() {
                    document.querySelectorAll('.session-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    option.classList.add('selected');
                    const radio = option.querySelector('input[type="radio"]');
                    radio.checked = true;
                    selectedSessionId = session.session_id;
                    
                    // „Çª„ÉÉ„Ç∑„Éß„É≥Ë®≠ÂÆö„Å´Âøú„Åò„Å¶„Éï„Ç©„Éº„É†„ÇíÊõ¥Êñ∞
                    updateFormForSession(session);
                    
                    // „ÇØ„É©„Ç§„Ç¢„É≥„ÉàID„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„É¶„Éº„Ç∂„Éº„Éë„Çπ„ÉØ„Éº„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
                    const clientId = document.getElementById('client-id').value.trim();
                    if (clientId) {
                        checkUserPassword(clientId);
                    }
                });
                
                container.appendChild(option);
            });
        }
        
        function updateFormForSession(session) {
            // „Çª„ÉÉ„Ç∑„Éß„É≥„Éë„Çπ„ÉØ„Éº„Éâ„Éï„Ç£„Éº„É´„Éâ
            const sessionPasswordField = document.getElementById('session-password-field');
            const sessionPasswordInput = document.getElementById('session-password');
            
            if (session.password_protected) {
                sessionPasswordField.style.display = 'block';
                sessionPasswordInput.required = true;
            } else {
                sessionPasswordField.style.display = 'none';
                sessionPasswordInput.required = false;
                sessionPasswordInput.value = '';
            }
            
            // „É¶„Éº„Ç∂„Éº„Éë„Çπ„ÉØ„Éº„ÉâË®≠ÂÆö„Å´Âøú„Åò„Å¶UI„ÇíÂ§âÊõ¥
            const usePasswordCheckbox = document.getElementById('use-password');
            const userPasswordField = document.getElementById('user-password-field');
            const userPasswordInput = document.getElementById('user-password');
            const hint = document.getElementById('user-password-hint');
            
            const usePasswordContainer = document.getElementById('use-password-container');
            
            if (session.disable_user_password) {
                // User password disabled - no password allowed
                usePasswordCheckbox.checked = false;
                usePasswordCheckbox.disabled = true;
                usePasswordContainer.style.display = 'none';
                userPasswordField.style.display = 'none';
                userPasswordInput.required = false;
                hint.textContent = 'Login without password (password disabled for this session)';
                hint.style.color = '#27ae60';
                hint.style.fontWeight = 'normal';
            } else if (session.require_user_password) {
                // User password required
                usePasswordCheckbox.checked = true;
                usePasswordCheckbox.disabled = true;
                usePasswordContainer.style.display = 'block';
                userPasswordField.style.display = 'block';
                userPasswordInput.required = true;
                userPasswordInput.placeholder = 'Enter password (required)';
                hint.textContent = 'Password required by session';
                hint.style.color = '#e74c3c';
                hint.style.fontWeight = 'bold';
            } else {
                // User password optional - can login without password
                usePasswordCheckbox.disabled = false;
                usePasswordContainer.style.display = 'block';
                // ÂàùÊúüÁä∂ÊÖã„ÅÆ„ÅøOFF„Å´Ë®≠ÂÆöÔºà„É¶„Éº„Ç∂„Éº„ÅåÈÅ∏ÊäûÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅØÂ∞äÈáçÔºâ
                if (!usePasswordCheckbox.checked) {
                    userPasswordField.style.display = 'none';
                    userPasswordInput.required = false;
                }
                hint.textContent = 'You can login without password';
                hint.style.color = '#27ae60';
                hint.style.fontWeight = 'normal';
            }
        }

        // „ÇØ„É©„Ç§„Ç¢„É≥„ÉàID„ÅÆÂÖ•Âäõ„Åß„É¶„Éº„Ç∂„Éº„Éë„Çπ„ÉØ„Éº„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
        document.getElementById('client-id').addEventListener('blur', async function() {
            const clientId = this.value.trim();
            if (clientId && selectedSessionId) {
                await checkUserPassword(clientId);
            }
        });
        
        // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂ§âÊõ¥„Åß„Éë„Çπ„ÉØ„Éº„ÉâÂÖ•ÂäõÊ¨Ñ„ÇíË°®Á§∫/ÈùûË°®Á§∫
        document.getElementById('use-password').addEventListener('change', function() {
            const userPasswordField = document.getElementById('user-password-field');
            const userPasswordInput = document.getElementById('user-password');
            
            if (this.checked) {
                userPasswordField.style.display = 'block';
                userPasswordInput.required = true;
            } else {
                userPasswordField.style.display = 'none';
                userPasswordInput.required = false;
                userPasswordInput.value = '';
            }
        });
        
        async function checkUserPassword(clientId) {
            if (!selectedSessionId) return;
            
            const selectedSession = sessions.find(s => s.session_id === selectedSessionId);
            if (!selectedSession) return;
            
            try {
                const response = await fetch(`/api/sessions/${selectedSessionId}/check_user_password?client_id=${encodeURIComponent(clientId)}`);
                const data = await response.json();
                
                const usePasswordCheckbox = document.getElementById('use-password');
                const usePasswordContainer = document.getElementById('use-password-container');
                const userPasswordField = document.getElementById('user-password-field');
                const userPasswordInput = document.getElementById('user-password');
                const hint = document.getElementById('user-password-hint');
                
                if (selectedSession.disable_user_password) {
                    // User password disabled - hide everything
                    usePasswordCheckbox.checked = false;
                    usePasswordCheckbox.disabled = true;
                    usePasswordContainer.style.display = 'none';
                    userPasswordField.style.display = 'none';
                    userPasswordInput.required = false;
                    hint.textContent = 'Login without password (password disabled for this session)';
                    hint.style.color = '#27ae60';
                    hint.style.fontWeight = 'normal';
                } else if (data.has_password) {
                    // Existing protected ID
                    usePasswordCheckbox.checked = true;
                    usePasswordCheckbox.disabled = true;
                    usePasswordContainer.style.display = 'block';
                    userPasswordField.style.display = 'block';
                    userPasswordInput.required = true;
                    userPasswordInput.placeholder = 'Enter password (protected ID)';
                    hint.textContent = 'This ID is password protected';
                    hint.style.color = '#e74c3c';
                    hint.style.fontWeight = 'bold';
                } else if (selectedSession.require_user_password) {
                    // Session requires user password
                    usePasswordCheckbox.checked = true;
                    usePasswordCheckbox.disabled = true;
                    usePasswordContainer.style.display = 'block';
                    userPasswordField.style.display = 'block';
                    userPasswordInput.required = true;
                    userPasswordInput.placeholder = 'Enter password (required)';
                    hint.textContent = 'Password required by session';
                    hint.style.color = '#e74c3c';
                    hint.style.fontWeight = 'bold';
                } else {
                    // New ID or unprotected ID (optional - can login without password)
                    usePasswordCheckbox.disabled = false;
                    usePasswordContainer.style.display = 'block';
                    // „É¶„Éº„Ç∂„Éº„ÅÆÈÅ∏Êäû„ÇíÂ∞äÈáçÔºàÊó¢„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Åù„ÅÆ„Åæ„ÅæÔºâ
                    if (!usePasswordCheckbox.checked) {
                        userPasswordField.style.display = 'none';
                        userPasswordInput.required = false;
                    } else {
                        userPasswordField.style.display = 'block';
                        userPasswordInput.required = true;
                    }
                    hint.textContent = 'You can login without password';
                    hint.style.color = '#27ae60';
                    hint.style.fontWeight = 'normal';
                }
            } catch (error) {
                console.error('Error checking user password:', error);
            }
        }
        
        // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°
        document.getElementById('login-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const clientId = document.getElementById('client-id').value.trim();
            const sessionPassword = document.getElementById('session-password').value;
            const userPassword = document.getElementById('user-password').value;
            
            if (!clientId) {
                alert('Please enter Client ID');
                return;
            }
            
            if (!selectedSessionId) {
                alert('Please select a session');
                return;
            }
            
            // Check if session is password protected
            const selectedSession = sessions.find(s => s.session_id === selectedSessionId);
            if (selectedSession && selectedSession.password_protected && !sessionPassword) {
                alert('Please enter session password');
                return;
            }
            
            // Check user password
            const userCheckResponse = await fetch(`/api/sessions/${selectedSessionId}/check_user_password?client_id=${encodeURIComponent(clientId)}`);
            const userCheckData = await userCheckResponse.json();
            
            // If ID is already protected, password required
            if (userCheckData.has_password && !userPassword) {
                alert('This ID is password protected. Please enter password.');
                return;
            }
            
            // If session requires user password for new IDs
            if (!userCheckData.has_password && selectedSession.require_user_password && !userPassword) {
                alert('Password is required for this session.');
                return;
            }
            
            // Êñ∞Ë¶è„É¶„Éº„Ç∂„ÉºID„Åß„Éë„Çπ„ÉØ„Éº„Éâ„ÇíË®≠ÂÆö„Åô„ÇãÂ†¥ÂêàÔºà„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„ÉÅ„Çß„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
            const usePasswordCheckbox = document.getElementById('use-password');
            if (!userCheckData.has_password && usePasswordCheckbox.checked && userPassword) {
                try {
                    await fetch(`/api/sessions/${selectedSessionId}/set_user_password?client_id=${encodeURIComponent(clientId)}&password=${encodeURIComponent(userPassword)}`, {
                        method: 'POST'
                    });
                } catch (error) {
                    console.error('Error setting user password:', error);
                    alert('Failed to set password');
                    return;
                }
            }
            
            // „ÇØ„É©„Ç§„Ç¢„É≥„ÉàID„ÇílocalStorage„Å´‰øùÂ≠ò
            localStorage.setItem('client_id', clientId);
            localStorage.setItem('session_id', selectedSessionId);
            
            // ÈÅ∏Êäû„Åó„Åü„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆ„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
            let url = `/chat?client_id=${encodeURIComponent(clientId)}&session_id=${selectedSessionId}`;
            if (sessionPassword) {
                url += `&session_password=${encodeURIComponent(sessionPassword)}`;
                localStorage.setItem('session_password_' + selectedSessionId, sessionPassword);
            }
            if (userPassword) {
                url += `&user_password=${encodeURIComponent(userPassword)}`;
                localStorage.setItem('user_password_' + selectedSessionId + '_' + clientId, userPassword);
            }
            window.location.href = url;
        });
    </script>
</body>
</html> 
